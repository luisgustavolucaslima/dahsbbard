<!DOCTYPE html>
<html lang="pt" class="has-aside-left has-aside-mobile-transition has-navbar-fixed-top has-aside-expanded">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Painel do Gerente de Vendas</title>
    <link rel="stylesheet" href="css/main.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css">
    <link href="https://fonts.googleapis.com/css?family=Nunito" rel="stylesheet" type="text/css">
    <link rel="stylesheet" href="https://cdn.materialdesignicons.com/4.9.95/css/materialdesignicons.min.css">
    <style>
      :root {
        --primary-color: #3273dc;
        --secondary-color: #f5f5f5;
        --text-color: #4a4a4a;
      }
      .table th, .table td {
        padding: 1rem;
        text-align: left;
        border-bottom: 1px solid #e5e7eb;
      }
      .table th {
        background-color: var(--secondary-color);
        color: var(--text-color);
        position: sticky;
        top: 0;
        z-index: 10;
      }
      .table-container {
        max-height: 400px;
        overflow-y: auto;
        margin-top: 1rem;
      }
      .modal-card-body {
        padding: 2rem;
        max-height: 70vh;
        overflow-y: auto;
      }
      .loader {
        border: 16px solid #f3f3f3;
        border-top: 16px solid var(--primary-color);
        border-radius: 50%;
        width: 120px;
        height: 120px;
        animation: spin 2s linear infinite;
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        z-index: 1000;
        display: none;
      }
      @keyframes spin {
        0% { transform: translate(-50%, -50%) rotate(0deg); }
        100% { transform: translate(-50%, -50%) rotate(360deg); }
      }
      .button.is-primary {
        background-color: var(--primary-color);
      }
      .field.is-grouped .control {
        margin-right: 0.75rem;
      }
      .box#comprovanteContainer {
        text-align: center;
      }
      .notification-container {
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 1000;
        max-width: 400px;
      }
      .notification {
        margin-bottom: 10px;
        opacity: 1;
        transition: opacity 0.3s ease-in-out;
      }
      .notification.fade-out {
        opacity: 0;
      }
    </style>
  </head>
  <body>
    <div class="modal" id="modalNovoPedido">
  <div class="modal-background"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">Novo Pedido Manual</p>
      <button class="delete" aria-label="close" id="fecharModalPedido"></button>
    </header>
    <section class="modal-card-body">
      <div class="field">
        <label class="label">Número do Cliente</label>
        <div class="control">
          <input class="input" id="clienteNumero" placeholder="Ex: 45991540729">
        </div>
      </div>

      <div id="listaProdutos">
        <div class="field is-grouped mb-2 produto-item">
          <div class="control is-expanded">
            <div class="select is-fullwidth">
              <select class="produtoSelect">
                <option value="">Selecione um produto</option>
              </select>
            </div>
          </div>
          <div class="control">
            <input class="input quantidadeInput" type="number" min="1" value="1">
          </div>
          <div class="control">
            <button class="button is-danger removerProduto" type="button">
              <span class="icon"><i class="mdi mdi-close"></i></span>
            </button>
          </div>
        </div>
      </div>

      <button class="button is-info is-light mb-4" type="button" id="adicionarProduto">
        <span class="icon"><i class="mdi mdi-plus"></i></span>
        <span>Adicionar Produto</span>
      </button>

      <div class="field">
        <label class="label">Forma de Pagamento</label>
        <div class="control">
          <div class="select is-fullwidth">
            <select id="formaPagamento">
              <option value="">Selecione</option>
              <option value="pix">PIX</option>
              <option value="dinheiro">Dinheiro</option>
              <option value="pix+dinheiro">PIX + Dinheiro</option>
            </select>
          </div>
        </div>
      </div>

      <div class="field" id="valorPagoContainer" style="display: none;">
        <label class="label">Valor Pago (dinheiro)</label>
        <div class="control">
          <input class="input" id="valorPago" type="number" min="0" step="0.01" placeholder="R$ 0,00">
        </div>
      </div>

      <div class="field" id="comprovanteContainer" style="display: none;">
        <label class="label">Comprovante de Pagamento (opcional)</label>
        <div class="control">
          <input type="file" id="comprovante" accept="image/*">
        </div>
      </div>
    </section>
    <footer class="modal-card-foot">
      <button class="button is-success" type="button" id="confirmarPedidoBtn">Salvar Pedido</button>
      <button class="button" id="cancelarPedidoBtn">Cancelar</button>
    </footer>
  </div>
</div>
    <div id="loader" class="loader"></div>
    <div id="app">
      <div id="notification-container" class="notification-container"></div>
      <nav id="navbar-main" class="navbar is-fixed-top">
        <div class="navbar-brand">
          <a class="navbar-item is-hidden-desktop jb-aside-mobile-toggle">
            <span class="icon"><i class="mdi mdi-forwardburger mdi-24px"></i></span>
          </a>
        </div>
        <div class="navbar-brand is-right">
          <a class="navbar-item is-hidden-desktop jb-navbar-menu-toggle" data-target="navbar-menu">
            <span class="icon"><i class="mdi mdi-dots-vertical"></i></span>
          </a>
        </div>
        <div class="navbar-menu fadeIn animated faster" id="navbar-menu">
          <div class="navbar-end">
            <a title="Log out" class="navbar-item is-desktop-icon-only">
              <span class="icon"><i class="mdi mdi-logout"></i></span><span>Log out</span>
            </a>
          </div>
        </div>
      </nav>
      <aside class="aside is-placed-left is-expanded">
        <div class="aside-tools">
          <div class="aside-tools-label">
            <span><b>Gerente de Vendas</b></span>
          </div>
        </div>
       <div class="menu is-menu-main">
        <p class="menu-label">Geral</p>
        <ul class="menu-list">
        <li><a href="index.html" class="is-active has-icon"><span class="icon"><i class="mdi mdi-desktop-mac"></i></span><span class="menu-item-label">Dashboard</span></a></li>
        <li><a href="estoque.html" class="has-icon"><span class="icon"><i class="mdi mdi-warehouse"></i></span><span class="menu-item-label">Estoque</span></a></li>
        <li><a href="lancamentos.html" class=" has-icon"><span class="icon"><i class="mdi mdi-cash-multiple"></i></span><span class="menu-item-label">Lancamentos</span></a></li>
        <li><a href="entregas.html" class=" has-icon"><span class="icon"><i class="mdi mdi-truck-delivery"></i></span><span class="menu-item-label">Entregas</span></a></li>
        <li><a href="conferencia.html" class=" has-icon"><span class="icon"><i class="mdi mdi-warehouse"></i></span><span class="menu-item-label">Conferencia</span></a></li>
        </ul>
       <p class="menu-label">Logic Ice</p>
        </div>
      </aside>
      <section class="section is-title-bar">
        <div class="level">
          <div class="level-left">
            <div class="level-item">
              <ul>
                <li>Gerente de Vendas</li>
                <li>Dashboard</li>
              </ul>
            </div>
          </div>
        </div>
      </section>
      <section class="hero is-hero-bar">
        <div class="hero-body">
          <div class="level">
            <div class="level-left">
              <div class="level-item"><h1 class="title">Painel do Gerente de Vendas</h1></div>
              <section class="section">
        <div class="buttons">
        <a class="button is-success is-light" id="abrirModalPedido">
        <span class="icon"><i class="mdi mdi-plus-circle-outline"></i></span>
        <span>Novo Pedido Manual</span>
          </a>
        <a href="estoque.html" class="button is-warning is-light">
          <span class="icon"><i class="mdi mdi-package-variant-closed"></i></span>
          <span>Estoque</span>
        </a>
        <a href="entregas.html" class="button is-link is-light">
          <span class="icon"><i class="mdi mdi-truck-delivery"></i></span>
          <span>Ver Entregas</span>
        </a>
        <a class="button is-link is-light" onclick="abrirModalEntrega()">🚚 Enviar para Entrega</a>
  </div>
</section>
            </div>
            <div class="level-right">
              <div class="level-item">
                <button id="refreshDashboardBtn" class="button is-primary">Atualizar</button>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section class="section is-main-section">
        <!-- Seção de Aprovação de Pagamentos -->
        <div class="card mb-6">
          <header class="card-header">
            <p class="card-header-title">
              <span class="icon"><i class="mdi mdi-approval"></i></span>
              Pedidos Pendentes de Aprovação
            </p>
          </header>
          <div class="card-content">
            <div class="table-container">
              <table class="table is-fullwidth is-striped is-hoverable">
                <thead>
                  <tr>
                    <th>Numero pedido Diario</th>
                    <th>Cliente</th>
                    <th>Valor Total</th>
                    <th>Ações</th>
                  </tr>
                </thead>
                <tbody id="pedidosPendentesTable"></tbody>
              </table>
            </div>
          </div>
        </div>
                <div class="card mb-5">
                        <header class="card-header">
                          <p class="card-header-title">
                            <span class="icon"><i class="mdi mdi-chart-donut"></i></span>
                            Resumo por Status
                          </p>
                    </header>
                    <div class="card-content">
                      <div class="columns is-multiline has-text-centered">
                        <div class="column is-one-fifth"><strong>Novo:</strong> <span id="status-novo">0</span></div>
                        <div class="column is-one-fifth"><strong>Embalado:</strong> <span id="status-embalado">0</span></div>
                        <div class="column is-one-fifth"><strong>Saída:</strong> <span id="status-entrega">0</span></div>
                        <div class="column is-one-fifth"><strong>Na Rua:</strong> <span id="status-rua">0</span></div>
                        <div class="column is-one-fifth"><strong>Finalizado:</strong> <span id="status-finalizado">0</span></div>
                      </div>
                </div>
      </div>

        <!-- Vendas Diárias (somente visualização) -->
        <div class="card mb-6">
          <header class="card-header">
            <p class="card-header-title">
              <span class="icon"><i class="mdi mdi-ballot"></i></span>
              Vendas Diárias
            </p>
          </header>
          <div class="card-content">
            <div class="field is-grouped">
              <p class="control is-expanded has-icons-left">
                <input class="input" type="text" id="clienteNumero" placeholder="Número do Cliente">
                <span class="icon is-small is-left"><i class="mdi mdi-account"></i></span>
              </p>
              <p class="control is-expanded has-icons-left">
                <input class="input" type="date" id="dataInicio" placeholder="Data Início">
                <span class="icon is-small is-left"><i class="mdi mdi-calendar"></i></span>
              </p>
              <p class="control is-expanded has-icons-left">
                <input class="input" type="date" id="dataFim" placeholder="Data Fim">
                <span class="icon is-small is-left"><i class="mdi mdi-calendar"></i></span>
              </p>
              <p class="control">
                <button id="filterVendasBtn" class="button is-primary">Filtrar</button>
              </p>
            </div>
            <div class="table-container">
              <table class="table is-fullwidth is-striped is-hoverable is-bordered">
                <thead>
                  <tr>
                    <th>ID da venda</th>
                    <th>Cliente</th>
                    <th>Valor Pago</th>
                    <th>Forma de Pagamento</th>
                    <th>Data</th>
                    <th>Status</th>
                  </tr>
                </thead>
                <tbody id="vendasTable"></tbody>
              </table>
            </div>
          </div>
        </div>
        <div class="modal" id="modalConfirmacao">
  <div class="modal-background" onclick="fecharModalConfirmacao()"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title" id="tituloConfirmacao">Confirmação</p>
      <button class="delete" aria-label="close" onclick="fecharModalConfirmacao()"></button>
    </header>
    <section class="modal-card-body">
      <p id="mensagemConfirmacao">Tem certeza que deseja realizar esta ação?</p>
    </section>
    <footer class="modal-card-foot">
      <button class="button is-danger" id="btnConfirmarAcao">Confirmar</button>
      <button class="button" onclick="fecharModalConfirmacao()">Cancelar</button>
    </footer>
  </div>
</div>
<div class="modal" id="modalEntrega">
  <div class="modal-background" onclick="fecharModalEntrega()"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">Selecionar Entregador</p>
      <button class="delete" aria-label="close" onclick="fecharModalEntrega()"></button>
    </header>
    <section class="modal-card-body">
      <div class="field">
        <label class="label">Entregador</label>
        <div class="control">
          <div class="select is-fullwidth">
            <select id="entregadorSelect"></select>
          </div>
        </div>
      </div>
      <div class="field">
        <label class="label">Pedidos para Entrega</label>
        <div id="listaPedidosEntrega" class="table-container"></div>
      </div>
    </section>
    <footer class="modal-card-foot">
      <button class="button is-success" onclick="atribuirEntregas()">Confirmar</button>
      <button class="button" onclick="fecharModalEntrega()">Cancelar</button>
    </footer>
  </div>
</div>

      </section>
      <footer class="footer">
        <div class="container-fluid">
          <div class="level">
            <div class="level-left">
              <div class="level-item">© 2025, M</div>
              <div class="level-item">
                <img src="https://img.shields.io/github/v/release/vikdiesel/admin-one-bulma-dashboard?color=%23999">
              </div>
            </div>
          </div>
        </div>
      </footer>
    </div>
    
    <script>

   async function atualizarResumoPorStatus() {
                      try {
                        const res = await fetch('/pedidos_diarios');
                        const pedidos = await res.json();

                        const statusMap = { novo: 0, embalado: 0, entrega: 0, finalizado: 0, rua: 0 };

                              pedidos.forEach(p => {
                    const status = (p.status || '').toLowerCase().trim();
                    if (statusMap.hasOwnProperty(status)) {
                      statusMap[status]++;
                    }
        });

                        for (const status in statusMap) {
                    const span = document.getElementById(`status-${status}`);
                    if (span) span.textContent = statusMap[status];
                  }
                      } catch (err) {
                        console.error("Erro ao carregar resumo de status:", err);
                      }
  }

function verComprovante(id) {
  fetch(`/comprovante/${id}`)
    .then(res => res.json())
    .then(data => {
      if (data.image) {
        const win = window.open("", "_blank");
        win.document.write(`
          <html>
            <head>
              <title>Comprovante do Pedido #${id}</title>
              <style>
                body {
                  background: #f4f4f4;
                  margin: 0;
                  padding: 0;
                  font-family: Arial, sans-serif;
                  display: flex;
                  flex-direction: column;
                  align-items: center;
                }
                header {
                  position: sticky;
                  top: 0;
                  width: 100%;
                  padding: 16px;
                  background-color: #ffffff;
                  border-bottom: 1px solid #ddd;
                  text-align: center;
                  font-size: 20px;
                  font-weight: bold;
                  box-shadow: 0 2px 5px rgba(0,0,0,0.05);
                  z-index: 1000;
                }
                #content {
                  margin-top: 30px;
                  padding: 20px;
                  display: flex;
                  justify-content: center;
                }
                img {
                  max-width: 90vw;
                  max-height: 80vh;
                  border: 2px solid #ccc;
                  box-shadow: 0 0 20px rgba(0, 0, 0, 0.1);
                  border-radius: 8px;
                }
                button#printBtn {
                  position: absolute;
                  top: 16px;
                  right: 16px;
                  background: #3273dc;
                  color: white;
                  border: none;
                  padding: 8px 12px;
                  border-radius: 4px;
                  cursor: pointer;
                  font-size: 14px;
                }
                @media (prefers-color-scheme: dark) {
                  body {
                    background: #1e1e1e;
                    color: #eee;
                  }
                  header {
                    background-color: #2b2b2b;
                    color: #eee;
                    border-bottom-color: #444;
                  }
                  img {
                    border-color: #444;
                  }
                }
              </style>
            </head>
            <body>
              <header>
                Comprovante do Pedido #${id}
                <button id="printBtn" onclick="window.print()">🖨 Imprimir</button>
              </header>
              <div id="content">Carregando comprovante...</div>
              <script>
                const img = new Image();
                img.src = "${data.image}";
                img.onload = () => {
                  const content = document.getElementById("content");
                  content.innerHTML = "";
                  content.appendChild(img);
                };
              <\/script>
            </body>
          </html>
        `);
        win.document.close();
      } else {
        showNotification("Comprovante não encontrado.", "warning");
      }
    })
    .catch(() => {
      showNotification("Erro ao buscar comprovante.", "danger");
    });
}

       async function salvarPagamento() {
          const forma = document.getElementById("formaPagamentoInput").value;

          if (!forma) {
            showNotification("Escolha uma forma de pagamento.", "warning");
            return;
          }

          try {
            const response = await fetch("/editar_pagamento", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id: pedidoIdParaPagamento, forma_pagamento: forma })
            });

            if (!response.ok) throw new Error("Erro ao atualizar pagamento.");

            showNotification("Forma de pagamento atualizada com sucesso!", "success");
            fecharModalPagamento();
            atualizarVendas(); // ou outra função de refresh da lista
          } catch (error) {
            showNotification("Erro ao atualizar pagamento: " + error.message, "danger");
          }
        


          try {
            const response = await fetch("/editar_pagamento", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ id: pedidoIdParaPagamento, forma_pagamento: forma })
            });

            if (!response.ok) throw new Error("Erro ao atualizar pagamento.");

            showNotification("Forma de pagamento atualizada com sucesso!", "success");
            fecharModalPagamento();
            atualizarVendas(); // ou outra função de refresh da lista
          } catch (error) {
            showNotification("Erro ao atualizar pagamento: " + error.message, "danger");
          }
        }

      // Funções de Notificação
      function showNotification(message, type = 'info') {
        const container = document.getElementById('notification-container');
        const notification = document.createElement('div');
        notification.className = `notification is-${type} is-light`;
        notification.innerHTML = `
          <button class="delete"></button>
          ${message}
        `;
        container.appendChild(notification);
        notification.querySelector('.delete').addEventListener('click', () => {
          notification.classList.add('fade-out');
          setTimeout(() => notification.remove(), 300);
        });
        setTimeout(() => {
          notification.classList.add('fade-out');
          setTimeout(() => notification.remove(), 300);
        }, 5000);
      }

      // Formatação de Dados
      function formatarData(data) {
        const d = new Date(data);
        return d.toLocaleString('pt-BR');
      }

      function formatarCliente(numero) {
        return numero.replace('@c.us', '');
      }

      // Verificação de Permissões
      document.addEventListener("DOMContentLoaded", () => {
        const permissao = localStorage.getItem('permissao');
        if (permissao !== 'vendas' && permissao !== 'admin')  {
          showNotification('Você não tem permissão para acessar essa área!', 'danger');
          setTimeout(() => { window.location.href = '../login.html'; }, 3000);
          return;
        }
        atualizarPedidosPendentes();
        atualizarVendas();
         atualizarResumoPorStatus();
      });

      // Logout
      document.querySelector('.navbar-item[title="Log out"]').addEventListener('click', () => {
        localStorage.removeItem('usuario');
        localStorage.removeItem('permissao');
        window.location.href = '../login.html';
      });

      // Atualizar Pedidos Pendentes
      async function atualizarPedidosPendentes() {
        try {
          const response = await fetch('/api/pedidos_pendentes');
          if (!response.ok) throw new Error(`Erro na resposta do servidor: ${response.status}`);
          const pedidos = await response.json();
          const tbody = document.getElementById('pedidosPendentesTable');
          tbody.innerHTML = '';
          pedidos.forEach(pedido => {
            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${pedido.numero_diario}</td>
              <td>${formatarCliente(pedido.cliente_numero)}</td>
              <td>R$ ${parseFloat(pedido.valor_total || 0).toFixed(2)}</td>
              <td>
                <button class="button is-small is-link" onclick="verComprovante(${pedido.id})">📥</button>
                <button id="aprovar-btn-${pedido.id}" class="button is-small is-success" onclick="confirmarAcao('Deseja realmente aprovar o pedido ${pedido.id}?', () => aprovarPedido(${pedido.id}))">✅</button>   <button class="button is-small is-danger" onclick="confirmarAcao('Deseja realmente negar o pedido ${pedido.id}?', () => negarPedido(${pedido.id}))">❌</button>
                <button class="button is-small is-warning" onclick="editarPagamento(${pedido.id})">💳</button>
                <button class="button is-small is-info" onclick="editarItens(${pedido.id})">🧾</button>
                <button class="button is-small is-info" onclick="informacoesDoPedido(${pedido.id})">🔍 Ver Pedido</button>
              </td>
            `;
            tbody.appendChild(row);
          });
          if (pedidos.length === 0) {
            tbody.innerHTML = '<tr><td colspan="4" class="has-text-centered">Nenhum pedido pendente</td></tr>';
          }
        } catch (err) {
    showNotification("Erro: " + err.message, "danger");
  }
      }

  async function aprovarPedido(id) {
  try {
    const btn = document.querySelector(`#aprovar-btn-${id}`);
    if (btn) btn.disabled = true;

    const response = await fetch('/valido', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ id, valido: 1 })
    });

    if (!response.ok) {
      const erro = await response.text();
      throw new Error(`Erro do servidor: ${erro}`);
    }

    showNotification('Pedido aprovado com sucesso!', 'success'); // Ajuste na mensagem
    atualizarPedidosPendentes();
    atualizarResumoPorStatus();
  } catch (err) {
    showNotification("Erro ao aprovar pedido: " + err.message, "danger");
  } finally {
    const btn = document.querySelector(`#aprovar-btn-${id}`);
    if (btn) btn.disabled = false;
  }
}


      // Negar Pedido
      async function negarPedido(id) {
        try {
          const response = await fetch('/valido', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ id, valido: 2 })
          });
          if (!response.ok) throw new Error(`Erro na resposta do servidor: ${response.status}`);
          showNotification('Pedido negado com sucesso!', 'success');
          atualizarPedidosPendentes();
        } catch (err) {
    showNotification("Erro: " + err.message, "danger");
  }
      }

      // Atualizar Vendas (somente visualização)
        async function atualizarVendas(filtros = {}) {
          document.getElementById('loader').style.display = 'block';
          try {
            filtros.page = filtros.page || 1;
            filtros.limit = 10;
            const query = new URLSearchParams(filtros).toString();
            const response = await fetch(`/api/vendas?${query}`);
            if (!response.ok) throw new Error(`Erro na resposta do servidor: ${response.status}`);
            const { vendas, total, page, totalPages } = await response.json();
            const tbody = document.getElementById('vendasTable');
            tbody.innerHTML = '';
            vendas.forEach(venda => {
              const row = document.createElement('tr');
              row.innerHTML = `
                <td>${venda.id}</td>
                <td>${formatarCliente(venda.cliente_numero)}</td>
                <td>R$ ${parseFloat(venda.valor_total || 0).toFixed(2)}</td>
                <td>${venda.forma_pagamento}</td>
                <td>${formatarData(venda.data)}</td>
                <td>${venda.status}</td>
              `;
              tbody.appendChild(row);
            });
            if (vendas.length === 0) {
              tbody.innerHTML = '<tr><td colspan="6" class="has-text-centered">Nenhuma venda encontrada</td></tr>';
            }
            // Adicione navegação de página
            const nav = document.createElement('nav');
            nav.className = 'pagination';
            nav.innerHTML = `
              <a class="pagination-previous" ${page === 1 ? 'disabled' : ''} onclick="atualizarVendas({ ...filtros, page: ${page - 1} })">Anterior</a>
              <a class="pagination-next" ${page >= totalPages ? 'disabled' : ''} onclick="atualizarVendas({ ...filtros, page: ${page + 1} })">Próxima</a>
              <span class="is-size-7">Página ${page} de ${totalPages} (${total} vendas)</span>
            `;
            tbody.parentElement.parentElement.appendChild(nav);
          } catch (err) {
            showNotification("Erro ao carregar vendas: " + err.message, "danger");
          } finally {
            document.getElementById('loader').style.display = 'none';
          }
        }

      // Eventos
      document.addEventListener('DOMContentLoaded', () => {
        document.getElementById('filterVendasBtn').addEventListener('click', (e) => {
          e.preventDefault();
          const filtros = {
            cliente_numero: document.getElementById('clienteNumero').value,
            data_inicio: document.getElementById('dataInicio').value,
            data_fim: document.getElementById('dataFim').value,
          };
          atualizarVendas(filtros);
        });

        document.getElementById('refreshDashboardBtn').addEventListener('click', () => {
        atualizarPedidosPendentes();
          atualizarVendas();
          atualizarResumoPorStatus(); // novo
        });
      });
    
      

      let pedidoIdParaPagamento = null;

          function editarPagamento(id) {
            pedidoIdParaPagamento = id;
            document.getElementById("modalPagamento").classList.add("is-active");
          }

          function fecharModalPagamento() {
            document.getElementById("modalPagamento").classList.remove("is-active");
            pedidoIdParaPagamento = null;
          }


      async function editarItens(id) {
        const raw = prompt("Informe os itens no formato: produto_id,quantidade;produto_id,quantidade");
        if (!raw) return;
        try {
          const itens = raw.split(";").map(i => {
            const [produto_id, quantidade] = i.split(",");
            return { produto_id: parseInt(produto_id), quantidade: parseInt(quantidade) };
          });
          const response = await fetch('/editar_itens', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ pedido_id: id, itens })
          });
          if (!response.ok) throw new Error("Erro ao atualizar itens.");
          showNotification("Itens do pedido atualizados com sucesso!", "success");
        } 
      catch (err) {
    showNotification("Erro: " + err.message, "danger");
  }
}


let produtosDisponiveis = [];
let pedidoIdParaItens = null;

async function carregarProdutos() {
  const res = await fetch('/api/produtos');
  produtosDisponiveis = await res.json();
}

function editarItens(id) {
  pedidoIdParaItens = id;
  document.getElementById("itensContainer").innerHTML = "";
  adicionarLinhaItem();
  document.getElementById("modalItens").classList.add("is-active");
}

function fecharModalItens() {
  document.getElementById("modalItens").classList.remove("is-active");
  pedidoIdParaItens = null;
}

function adicionarLinhaItem() {
  const container = document.getElementById("itensContainer");
  const div = document.createElement("div");
  div.className = "field is-grouped mt-2";
  div.innerHTML = `
    <div class="control is-expanded">
      <div class="select is-fullwidth">
        <select class="select-produto">
          ${produtosDisponiveis.map(p => `<option value="${p.id}">${p.nome}</option>`).join("")}
        </select>
      </div>
    </div>
    <div class="control">
      <input type="number" min="1" value="1" class="input quantidade" style="width: 80px;">
    </div>
    <div class="control">
      <button class="button is-danger is-light" onclick="this.closest('.field').remove()">✖</button>
    </div>
  `;
  container.appendChild(div);
}

async function salvarItens() {
  const linhas = [...document.querySelectorAll("#itensContainer .field")];
  const itens = linhas.map(linha => {
    const produto_id = parseInt(linha.querySelector(".select-produto").value);
    const quantidade = parseInt(linha.querySelector(".quantidade").value);
    return { produto_id, quantidade };
  });

  if (itens.length === 0) {
    showNotification("Adicione ao menos um item", "warning");
    return;
  }

  try {
    const response = await fetch("/editar_itens", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ pedido_id: pedidoIdParaItens, itens })
    });
    if (!response.ok) throw new Error("Erro ao salvar itens");
    showNotification("Itens atualizados com sucesso!", "success");
    fecharModalItens();
  } catch (err) {
    showNotification("Erro: " + err.message, "danger");
  }
}


document.addEventListener("DOMContentLoaded", carregarProdutos);

  const modal = document.getElementById('modalNovoPedido');
document.getElementById('abrirModalPedido').addEventListener('click', () => {
  modal.classList.add('is-active');
  carregarProdutos();
});

document.getElementById('fecharModalPedido').addEventListener('click', () => modal.classList.remove('is-active'));
document.getElementById('cancelarPedidoBtn').addEventListener('click', () => modal.classList.remove('is-active'));

document.getElementById('formaPagamento').addEventListener('change', (e) => {
  const pagamento = e.target.value;
  document.getElementById('valorPagoContainer').style.display = pagamento === 'dinheiro' || pagamento === 'pix+dinheiro' ? 'block' : 'none';
  document.getElementById('comprovanteContainer').style.display = pagamento.includes('pix') ? 'block' : 'none';
});


async function carregarProdutos() {
  const res = await fetch('/api/produtos');
  produtosDisponiveis = await res.json();
  atualizarSelectsProduto();
}

function atualizarSelectsProduto() {
  document.querySelectorAll('.produtoSelect').forEach(select => {
    select.innerHTML = `<option value="">Selecione um produto</option>`;
    produtosDisponiveis.forEach(p => {
      select.innerHTML += `<option value="${p.id}">${p.nome} - R$ ${parseFloat(p.valor_unitario).toFixed(2)}</option>`;
    });
  });
}

document.getElementById('adicionarProduto').addEventListener('click', () => {
  const novaLinha = document.createElement('div');
  novaLinha.className = 'field is-grouped mb-2 produto-item';
  novaLinha.innerHTML = `
    <div class="control is-expanded">
      <div class="select is-fullwidth">
        <select class="produtoSelect"></select>
      </div>
    </div>
    <div class="control">
      <input class="input quantidadeInput" type="number" min="1" value="1">
    </div>
    <div class="control">
      <button class="button is-danger removerProduto" type="button">
        <span class="icon"><i class="mdi mdi-close"></i></span>
      </button>
    </div>
  `;
  document.getElementById('listaProdutos').appendChild(novaLinha);
  atualizarSelectsProduto();
});

document.getElementById('listaProdutos').addEventListener('click', (e) => {
  if (e.target.closest('.removerProduto')) {
    e.target.closest('.produto-item').remove();
  }
});

document.getElementById('confirmarPedidoBtn').addEventListener('click', async () => {
  const cliente = document.getElementById('clienteNumero').value.trim();
  const pagamento = document.getElementById('formaPagamento').value
  const valorPago = document.getElementById('valorPago').value;
  const comprovanteFile = document.getElementById('comprovante').files[0];

  if (!cliente || !pagamento ) {
    mostrarToast('Preencha todos os campos obrigatórios.', false);
    return;
  }

  const produtos = Array.from(document.querySelectorAll('.produto-item')).map(item => {
    return {
      produto_id: item.querySelector('.produtoSelect').value,
      quantidade: parseInt(item.querySelector('.quantidadeInput').value)
    };
  }).filter(p => p.produto_id && p.quantidade > 0);

  if (produtos.length === 0) {
    mostrarToast('Adicione ao menos 1 produto.', false);
    return;
  }

  const formData = new FormData();
  formData.append('cliente_numero', cliente);
  formData.append('forma_pagamento', pagamento);
  formData.append('itens', JSON.stringify(produtos));
if (valorPago) {
  formData.append('valor_pago', valorPago); // SEMPRE envia
  if (pagamento === 'pix+dinheiro') {
    formData.append('valor_dinheiro', valorPago); // SOMENTE se for PIX + dinheiro
  }
  if (pagamento === 'dinheiro') {
    formData.append('valor_dinheiro', valorPago); // SOMENTE se for PIX + dinheiro
  }
}
if (comprovanteFile) {
  formData.append('comprovante', comprovanteFile);
}


  try {
    const resposta = await fetch('/api/pedido_manual', {
      method: 'POST',
      body: formData
    });

    const json = await resposta.json();
    mostrarToast(json.mensagem || 'Pedido registrado!', resposta.ok);
    if (resposta.ok) modal.classList.remove('is-active');
  } catch (e) {
    mostrarToast('Erro ao enviar pedido.', false);
  }

});

function mostrarToast(msg, sucesso = true) {
  const toast = document.getElementById('toast');
  toast.className = `notification is-light ${sucesso ? 'is-success' : 'is-danger'}`;
  toast.textContent = msg;
  toast.style.display = 'block';
  setTimeout(() => toast.style.display = 'none', 3000);
}


let acaoConfirmada = null;

function confirmarAcao(mensagem, callback) {
  document.getElementById('mensagemConfirmacao').textContent = mensagem;
  document.getElementById('modalConfirmacao').classList.add('is-active');
  acaoConfirmada = callback;
}

document.getElementById('btnConfirmarAcao').addEventListener('click', () => {
  if (acaoConfirmada) acaoConfirmada();
  fecharModalConfirmacao();
});

function fecharModalConfirmacao() {
  document.getElementById('modalConfirmacao').classList.remove('is-active');
  acaoConfirmada = null;
}

</script>
  
<!-- Modal: Editar Pagamento -->
<div class="modal" id="modalPagamento">
  <div class="modal-background" onclick="fecharModalPagamento()"></div>
  <div class="modal-card">
    <header class="modal-card-head">
      <p class="modal-card-title">Editar Forma de Pagamento</p>
      <button class="delete" aria-label="close" onclick="fecharModalPagamento()"></button>
    </header>
    <section class="modal-card-body">
      <div class="field">
        <label class="label">Forma de Pagamento</label>
        <div class="control">
          <div class="select is-fullwidth">
            <select id="formaPagamentoInput">
              <option value="">Selecione</option>
              <option value="pix">PIX</option>
              <option value="dinheiro">Dinheiro</option>
              <option value="pix+dinheiro">Pix + Dinheiro</option>
            </select>
          </div>
        </div>
      </div>
    </section>
    <footer class="modal-card-foot">
      <button class="button is-success" onclick="salvarPagamento()">Salvar</button>
      <button class="button" onclick="fecharModalPagamento()">Cancelar</button>
    </footer>
  </div>
</div>


<!-- Modal: Editar Itens -->
<div class="modal" id="modalItens">
  <div class="modal-background" onclick="fecharModalItens()"></div>
  <div class="modal-card" style="width: 600px;">
    <header class="modal-card-head">
      <p class="modal-card-title">Editar Itens do Pedido</p>
      <button class="delete" aria-label="close" onclick="fecharModalItens()"></button>
    </header>
    <section class="modal-card-body">
      <div id="itensContainer"></div>
      <button class="button is-small is-info mt-2" onclick="adicionarLinhaItem()">+ Adicionar Item</button>
    </section>
    <footer class="modal-card-foot">
      <button class="button is-success" onclick="salvarItens()">Salvar</button>
      <button class="button" onclick="fecharModalItens()">Cancelar</button>
    </footer>
  </div>
</div>

<!-- Modal de Informações do Pedido -->
<div class="modal" id="modalInfoPedido">
  <div class="modal-background" onclick="fecharModalInfo()"></div>
  <div class="modal-card" style="width: 600px;">
    <header class="modal-card-head">
      <p class="modal-card-title">Detalhes do Pedido</p>
      <button class="delete" aria-label="close" onclick="fecharModalInfo()"></button>
    </header>
    <section class="modal-card-body">
      <div id="detalhesPedidoContent">
        <p><strong>Numero do pedido diario:</strong> <span id="infoId"></span></p>
        <p><strong>Cliente:</strong> <span id="infoCliente"></span></p>
        <p><strong>Produtos:</strong> <span id="infoProdutos"></span></p>
        <p><strong>Valor Total:</strong> R$ <span id="infoValor"></span></p>
        <p><strong>Forma de Pagamento:</strong> <span id="infoPagamento"></span></p>
        <p><strong>Status:</strong> <span id="infoStatus"></span></p>
        <p><strong>Data:</strong> <span id="infoData"></span></p>
      </div>
    </section>
    <footer class="modal-card-foot">
      <button class="button" onclick="fecharModalInfo()">Fechar</button>
    </footer>
  </div>
</div>

<script>


function abrirModalEntrega() {
  document.getElementById('modalEntrega').classList.add('is-active');
  carregarEntregadores();
  carregarPedidosParaEntrega();
}

function fecharModalEntrega() {
  document.getElementById('modalEntrega').classList.remove('is-active');
}

async function carregarEntregadores() {
  const res = await fetch('/api/entregadores-disponiveis');
  const dados = await res.json();
  const select = document.getElementById('entregadorSelect');
  select.innerHTML = '<option value="">Selecione</option>';
  dados.forEach(e => {
    select.innerHTML += `<option value="${e.id}">${e.nome}</option>`;
  });
}

async function carregarPedidosParaEntrega() {
  const res = await fetch('/pedidos_entrega');
  const pedidos = await res.json();
  const lista = pedidos.filter(p => p.status === 'entrega');
  const container = document.getElementById('listaPedidosEntrega');
  container.innerHTML = `
    <table class="table is-fullwidth is-bordered">
      <thead><tr><th>#</th><th>Cliente</th></tr></thead>
      <tbody>
        ${lista.map(p => `
          <tr>
            <td>${p.numero_diario}</td>
            <td>${p.cliente_numero}</td
            <td><input type="checkbox" class="checkPedidoEntrega" value="${p.id}"></td>
          </tr>`).join('')}
      </tbody>
    </table>
  `;
}

async function atribuirEntregas() {
  const entregador_id = document.getElementById('entregadorSelect').value;
  const selecionados = [...document.querySelectorAll('.checkPedidoEntrega:checked')].map(el => parseInt(el.value));

  if (!entregador_id || selecionados.length < 1) {
    showNotification('Selecione um entregador e ao menos 1 pedidos.', 'warning');
    return;
  }

  const res = await fetch('/api/atribuir-entregas', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ entregador_id, pedidos: selecionados })
  });

  const data = await res.json();
  showNotification(data.mensagem || 'Entregas atribuídas.');
  fecharModalEntrega();
  atualizarPedidosPendentes?.();
}


function informacoesDoPedido(id) {
  fetch('/api/pedidos/' + id)
    .then(res => res.json())
    .then(p => {
      if (!p || p.erro) {
        showNotification("Pedido não encontrado.", "warning");
        return;
      }

      document.getElementById('infoId').textContent =
        p.numero_diario ?? p.id ?? id;

      document.getElementById('infoCliente').textContent =
        p.cliente_numero?.replace('@c.us', '') || "-";

      document.getElementById('infoProdutos').textContent =
        p.itens || p.produtos || "-";

      document.getElementById('infoValor').textContent =
        p.valor_total && p.valor_total !== "-" ? `R$ ${parseFloat(p.valor_total).toFixed(2)}` : "-";

      document.getElementById('infoPagamento').textContent =
        p.forma_pagamento || "-";

      document.getElementById('infoStatus').textContent =
        p.status || "-";

      const dataFormatada = p.data_pedido || p.data;
      document.getElementById('infoData').textContent =
        dataFormatada ? new Date(dataFormatada).toLocaleString("pt-BR") : "-";

      document.getElementById('modalInfoPedido').classList.add('is-active');
    })
    .catch(err => {
      showNotification("Erro ao carregar pedido: " + err.message, "danger");
    });
}


function fecharModalInfo() {
  document.getElementById('modalInfoPedido').classList.remove('is-active');
}



</script>

<div id="toast" class="notification is-light is-success" style="display:none; position:fixed; top:1rem; right:1rem; z-index:1000;"></div>
</body>
</html>